name: dc-v2

topology:
  nodes:
    # spines
    spine01:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - spine-1/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - spine-1/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.3
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.3'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    spine02:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - spine-2/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - spine-2/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.3
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.4'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    # borders
    border01:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - border-1/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - border-1/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.3
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.1'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2
      # stages:
      #   create:
      #     wait-for:
      #       - node: spine01
      #         stage: healthy
      #       - node: spine02
      #         stage: healthy

    border02:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - border-2/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - border-2/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.3
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.2'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2
      # stages:
      #   create:
      #     wait-for:
      #       - node: spine01
      #         stage: healthy
      #       - node: spine02
      #         stage: healthy

    # leaf
    leaf01:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - leaf-1/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - leaf-1/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.5
      # stages:
      #   create:
      #     wait-for:
      #       - node: border01
      #         stage: healthy
      #       - node: border02
      #         stage: healthy
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.5'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    leaf02:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - leaf-2/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - leaf-2/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.5
      # stages:
      #   create:
      #     wait-for:
      #       - node: border01
      #         stage: healthy
      #       - node: border02
      #         stage: healthy
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.6'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    leaf03:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - leaf-3/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - leaf-3/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.5
      # stages:
      #   create:
      #     wait-for:
      #       - node: border01
      #         stage: healthy
      #       - node: border02
      #         stage: healthy
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.7'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    leaf04:
      kind: cumulus_cvx
      image: cx_ebtables:5.3.0
      runtime: docker
      binds:
        - /lib/modules:/lib/modules:ro # for kernel modules like ebtables
        - leaf-4/interfaces:/etc/network/interfaces.d/host-mounts
        - 01-common/entrypoint.sh:/root/entrypoint.sh
        - 01-common/apply-nvue.sh:/root/apply-nvue.sh
        - leaf-4/nvue.yml:/home/cumulus/nvue.yml
      entrypoint: /root/entrypoint.sh
      cpu: 0.5
      # stages:
      #   create:
      #     wait-for:
      #       - node: border01
      #         stage: healthy
      #       - node: border02
      #         stage: healthy
      # healthcheck:
      #   test:
      #     - CMD-SHELL
      #     - ip a | grep '172.30.0.8'
      #   start-period: 10
      #   retries: 5
      #   interval: 5
      #   timeout: 2

    server01:
      kind: linux
      image: networkop/host:ifreload
      # image: host_updated:ifreload
      binds:
      - server01/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf01
      #         stage: healthy
      #       - node: leaf02
      #         stage: healthy


    server02:
      kind: linux
      image: networkop/host:ifreload
      binds:
      - server02/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf01
      #         stage: healthy
      #       - node: leaf02
      #         stage: healthy      
    server03:
      kind: linux
      image: networkop/host:ifreload
      binds:
      - server03/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf01
      #         stage: healthy
      #       - node: leaf02
      #         stage: healthy
    server04:
      kind: linux
      image: networkop/host:ifreload
      binds:
      - server04/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf03
      #         stage: healthy
      #       - node: leaf04
      #         stage: healthy
    server05:
      kind: linux
      image: networkop/host:ifreload
      binds:
      - server05/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf03
      #         stage: healthy
      #       - node: leaf04
      #         stage: healthy

    server06:
      kind: linux
      image: networkop/host:ifreload
      binds:
      - server06/etc/network/interfaces:/etc/network/interfaces
      # stages:
      #   create:
      #     wait-for:
      #       - node: leaf03
      #         stage: healthy
      #       - node: leaf04
      #         stage: healthy


  links:
    # peerlinks
    - endpoints: ["border01:swp49", "border02:swp49"]
    - endpoints: ["border01:swp50", "border02:swp50"]

    - endpoints: [ "spine01:swp5", "border01:swp51" ]
    - endpoints: [ "spine02:swp5", "border01:swp52" ]

    - endpoints: [ "spine01:swp6", "border02:swp51" ]
    - endpoints: [ "spine02:swp6", "border02:swp52" ]

    - endpoints: [ "spine01:swp1", "leaf01:swp51" ]
    - endpoints: [ "spine02:swp1", "leaf01:swp52" ]

    - endpoints: [ "spine01:swp2", "leaf02:swp51" ]
    - endpoints: [ "spine02:swp2", "leaf02:swp52" ]

    - endpoints: [ "spine01:swp3", "leaf03:swp51" ]
    - endpoints: [ "spine02:swp3", "leaf03:swp52" ]

    - endpoints: [ "spine01:swp4", "leaf04:swp51" ]
    - endpoints: [ "spine02:swp4", "leaf04:swp52" ]


    - endpoints: [ "leaf01:swp49", "leaf02:swp49" ]
    - endpoints: [ "leaf01:swp50", "leaf02:swp50" ]

    - endpoints: [ "leaf03:swp49", "leaf04:swp49" ]
    - endpoints: [ "leaf03:swp50", "leaf04:swp50" ]

    - endpoints: [ "server01:eth1", "leaf01:swp1" ]
    - endpoints: [ "server01:eth2", "leaf02:swp1" ]

    - endpoints: [ "server02:eth1", "leaf01:swp2" ]
    - endpoints: [ "server02:eth2", "leaf02:swp2" ]

    - endpoints: [ "server03:eth1", "leaf01:swp3" ]
    - endpoints: [ "server03:eth2", "leaf02:swp3" ]

    - endpoints: [ "server04:eth1", "leaf03:swp1" ]
    - endpoints: [ "server04:eth2", "leaf04:swp1" ]

    - endpoints: [ "server05:eth1", "leaf03:swp2" ]
    - endpoints: [ "server05:eth2", "leaf04:swp2" ]

    - endpoints: [ "server06:eth1", "leaf03:swp3" ]
    - endpoints: [ "server06:eth2", "leaf04:swp3" ]

